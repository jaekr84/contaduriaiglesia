generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  auditEnabled Boolean @default(true)
  createdAt DateTime @default(now())

  profiles     Profile[]
  transactions Transaction[]
  categories   Category[]
  members      Member[]
  invitations  Invitation[]
  auditLogs    AuditLog[]
  budgets      Budget[]
}

model Invitation {
  id             String       @id @default(uuid())
  email          String
  role           Role         @default(VIEWER)
  token          String       @unique
  status         String       @default("PENDING") // PENDING, ACCEPTED, REVOKED
  expiresAt      DateTime
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, email])
}

model Profile {
  id             String       @id // References auth.users.id
  email          String
  fullName       String?
  sessionId      String?
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  role           Role         @default(VIEWER)

  createdAt DateTime @default(now())

  createdTransactions   Transaction[] @relation("CreatedBy")
  cancelledTransactions Transaction[] @relation("CancelledBy")
  
  createdBudgets        Budget[]      @relation("BudgetCreatedBy")
  updatedBudgets        Budget[]      @relation("BudgetUpdatedBy")
}


enum Role {
  ADMIN
  TREASURER // Tesorero
  VIEWER
  RRHH // Recursos Humanos - Solo acceso a miembros
}

model Category {
  id             String          @id @default(uuid())
  name           String
  type           TransactionType
  organizationId String
  organization   Organization    @relation(fields: [organizationId], references: [id])
  transactions   Transaction[]
  isSystem       Boolean         @default(false)
  order          Int             @default(0)

  parentId       String?
  parent         Category?       @relation("CategoryHierarchy", fields: [parentId], references: [id])
  subcategories  Category[]      @relation("CategoryHierarchy")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Unique name only within the same parent level? Or generally?
  // Let's keep it simple: Name unique per type/org is too restrictive for subcategories (e.g. 'General' in multiple places).
  // So we remove the global unique constraint or add parentId. 
  // Postgres treats NULLs as distinct for unique indexes usually, but let's just make it loose for now.
  @@index([organizationId, type])

  budgets Budget[]
}

model Member {
  id        String   @id @default(uuid())
  firstName String
  lastName  String
  email     String?
  phone     String?
  address   String?
  gender    String?
  country   String?
  state     String?
  city      String?
  birthDate DateTime?
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])
  
  transactions Transaction[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@unique([email, organizationId])
}


enum Currency {
  ARS
  USD
}

model Transaction {
  id          String          @id @default(uuid())
  amount      Decimal         @db.Decimal(10, 2)
  currency    Currency        @default(ARS)
  description String?
  date        DateTime        @default(now())
  type        TransactionType
  paymentMethod PaymentMethod @default(CASH)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  memberId    String?
  member      Member?  @relation(fields: [memberId], references: [id])

  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdById String?
  createdBy   Profile?  @relation("CreatedBy", fields: [createdById], references: [id])
  
  // Cancellation fields
  cancelledAt     DateTime?
  cancelledById   String?
  cancelledBy     Profile?  @relation("CancelledBy", fields: [cancelledById], references: [id])
  cancellationReason String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, date])
  @@index([organizationId, type])
  @@index([categoryId])
  @@index([cancelledAt])
}

model Budget {
  id             String       @id @default(uuid())
  amount         Decimal      @db.Decimal(10, 2)
  month          Int          // 1-12
  year           Int
  currency       Currency     @default(ARS)
  
  categoryId     String
  category       Category     @relation(fields: [categoryId], references: [id])
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id])

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  createdById    String?
  createdBy      Profile?     @relation("BudgetCreatedBy", fields: [createdById], references: [id])
  updatedById    String?
  updatedBy      Profile?     @relation("BudgetUpdatedBy", fields: [updatedById], references: [id])

  // Ensures only one budget per category per month/year
  @@unique([organizationId, categoryId, month, year])
  @@index([organizationId, month, year])
}

enum TransactionType {
  INCOME
  EXPENSE
  OPENING_BALANCE
}

enum PaymentMethod {
  CASH
  TRANSFER
  DEBIT
  CREDIT
  QR
  OTHER
}

model AuditLog {
  id             String         @id @default(uuid())
  eventType      AuditEventType
  severity       AuditSeverity  @default(INFO)
  userId         String?        // Puede ser null para intentos fallidos
  userEmail      String
  organizationId String
  organization   Organization   @relation(fields: [organizationId], references: [id])

  // Detalles del evento (incluye diff para updates)
  details     Json?   // Para updates: { "previous": {...}, "new": {...} }
  ipAddress   String?
  userAgent   String?

  // Metadata
  resourceType String? // ej: "Transaction", "Category", "Member"
  resourceId   String? // ID del recurso afectado

  createdAt DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([userId])
  @@index([eventType])
  @@index([severity])
}

enum AuditEventType {
  // Authentication
  LOGIN_SUCCESS
  LOGIN_FAILED
  LOGOUT

  // Transactions
  TRANSACTION_CREATED
  TRANSACTION_UPDATED
  TRANSACTION_DELETED

  // Categories
  CATEGORY_CREATED
  CATEGORY_UPDATED
  CATEGORY_DELETED

  // Members
  MEMBER_CREATED
  MEMBER_UPDATED
  MEMBER_DELETED

  // Users & Invitations
  USER_INVITED
  USER_REMOVED
  INVITATION_REVOKED
  INVITATION_ACCEPTED

  // Budgets
  BUDGET_CREATED
  BUDGET_UPDATED
  BUDGET_BATCH_UPDATE
}

enum AuditSeverity {
  INFO     // Operaciones normales
  WARN     // Eventos que requieren atenci√≥n
  CRITICAL // Fallos de login, eliminaciones, cambios importantes
}
